<div class="checkout-wrapper">
  <div class="alerts">
    <div class="alert error" *ngIf="errorMessage">
      <mat-icon>error_outline</mat-icon>
      <span>{{ errorMessage }}</span>
    </div>
    <div class="alert success" *ngIf="successMessage">
      <mat-icon>check_circle</mat-icon>
      <span>{{ successMessage }}</span>
    </div>
  </div>

  <ng-container *ngIf="hasItems; else emptyCart">
    <div class="checkout-container">
      <div class="checkout-grid">
        <mat-card class="details-card">
          <mat-card-header>
            <mat-card-title>Delivery & Payment</mat-card-title>
            <mat-card-subtitle>Provide where we should ship your order and pick a payment method.</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-form">
              <mat-form-field appearance="outline">
                <mat-label>Shipping Address</mat-label>
                <textarea
                  matInput
                  rows="4"
                  formControlName="shippingAddress"
                  placeholder="Street, city, state, ZIP"
                  [disabled]="isProcessing"
                ></textarea>
                <mat-error *ngIf="checkoutForm.get('shippingAddress')?.hasError('required')">
                  Shipping address is required.
                </mat-error>
                <mat-error *ngIf="checkoutForm.get('shippingAddress')?.hasError('minlength')">
                  Please provide a complete address (at least 10 characters).
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Payment Method</mat-label>
                <mat-select formControlName="paymentMethod" [disabled]="isProcessing">
                  <mat-option *ngFor="let method of paymentMethodOptions" [value]="method">
                    {{ method === 'CARD' ? 'Credit / Debit Card' : 'Pay on Delivery' }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="checkoutForm.get('paymentMethod')?.hasError('required')">
                  Payment method is required.
                </mat-error>
              </mat-form-field>

              <button mat-raised-button color="primary" type="submit" [disabled]="checkoutForm.invalid || isProcessing">
                <span>Complete Checkout</span>
                <mat-progress-spinner
                  *ngIf="isProcessing"
                  diameter="18"
                  mode="indeterminate"
                ></mat-progress-spinner>
              </button>
              <button mat-button type="button" color="accent" routerLink="/cart" [disabled]="isProcessing">
                Back to Cart
              </button>
            </form>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card">
          <mat-card-header>
            <mat-card-title>Order Summary</mat-card-title>
            <mat-card-subtitle>Review items and totals before placing the order.</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <mat-list>
              <mat-list-item *ngFor="let item of cart?.items">
                <div matListItemAvatar class="product-avatar">
                  <mat-icon>inventory_2</mat-icon>
                </div>
                <div matListItemTitle>{{ getProductName(item.productId) }}</div>
                <div matListItemLine>{{ item.quantity }} Ã— {{ productDetails[item.productId]?.price | currency:'USD' }}</div>
                <div matListItemMeta>{{ getItemSubtotal(item) | currency:'USD' }}</div>
              </mat-list-item>
            </mat-list>

            <mat-divider></mat-divider>
            <div class="total-row">
              <span>Total</span>
              <span>{{ cartTotal | currency:'USD' }}</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </ng-container>
</div>

<ng-template #emptyCart>
  <div class="empty-state">
    <mat-icon>shopping_cart</mat-icon>
    <h2>Your cart is empty</h2>
    <p>Add products to your cart before checking out.</p>
    <button mat-raised-button color="primary" routerLink="/home">Browse Products</button>
  </div>
</ng-template>
